<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Global Water Level Slider</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link
      href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: sans-serif;
      }
      #cesiumContainer {
        width: 100%;
        height: 100vh;
      }

      /* Floating UI Control */
      #uiContainer {
        position: absolute;
        top: 1.25rem;
        left: 1.25rem;
        background: rgba(42, 42, 42, 0.8);
        padding: 0.9375rem;
        border-radius: 0.5rem;
        color: white;
        z-index: 100;
        width: 18.75rem;
        backdrop-filter: blur(0.3125rem);
      }
      input[type='range'] {
        width: 100%;
        margin: 0.625rem 0;
      }
      .label-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
      }
      #currentHeight {
        font-weight: bold;
        color: #4db8ff;
      }
    </style>
  </head>
  <body>
    <div id="uiContainer">
      <h3>Global Water Level</h3>
      <div class="label-row">
        <span>Current Level:</span>
        <span id="currentHeight">0 ft</span>
      </div>
      <input
        type="range"
        id="heightSlider"
        min="-37417"
        max="30032"
        value="0"
        step="100"
      />
      <div class="label-row">
        <span>-37,417 ft (Deep Ocean)</span>
        <span>+30,032 ft (Everest)</span>
      </div>
      <p style="font-size: 0.8em; color: #aaa; margin-top: 0.625rem">
        Move slider to flood the world or drain the oceans.
      </p>
      <button
        id="changeTokenBtn"
        style="
          margin-top: 0.625rem;
          padding: 0.3rem 0.6rem;
          font-size: 0.75em;
          background: #555;
          color: #ccc;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        "
      >
        Change Cesium Token
      </button>
    </div>

    <div id="cesiumContainer"></div>

    <script>
      // 1. SETUP: Get Cesium token from local storage or prompt user
      const CESIUM_TOKEN_KEY = 'cesiumIonAccessToken';

      function getCesiumToken() {
        let token = localStorage.getItem(CESIUM_TOKEN_KEY);
        if (!token) {
          token = prompt(
            'Please enter your Cesium ion Access Token.\n\n' +
              'You can get a free token at: https://ion.cesium.com/tokens\n\n' +
              'This will be saved in your browser for future visits.',
          );
          if (token) {
            localStorage.setItem(CESIUM_TOKEN_KEY, token.trim());
          }
        }
        return token;
      }

      function clearCesiumToken() {
        localStorage.removeItem(CESIUM_TOKEN_KEY);
        location.reload();
      }

      const cesiumToken = getCesiumToken();
      if (!cesiumToken) {
        document.body.innerHTML =
          '<div style="padding: 20px; font-family: sans-serif;">' +
          '<h2>Cesium Token Required</h2>' +
          '<p>A Cesium ion access token is required to use this application.</p>' +
          '<p>Get a free token at: <a href="https://ion.cesium.com/tokens" target="_blank">https://ion.cesium.com/tokens</a></p>' +
          '<button onclick="location.reload()">Try Again</button>' +
          '</div>';
        throw new Error('No Cesium token provided');
      }

      Cesium.Ion.defaultAccessToken = cesiumToken;

      // 2. INITIALIZE VIEWER
      const viewer = new Cesium.Viewer('cesiumContainer', {
        baseLayerPicker: true,
        animation: false,
        timeline: false,
      });

      // Set terrain with async method (new API for Cesium 1.104+)
      Cesium.CesiumTerrainProvider.fromIonAssetId(1, {
        requestWaterMask: true,
        requestVertexNormals: true,
      }).then(function (terrainProvider) {
        viewer.terrainProvider = terrainProvider;
      });

      // 3. ENABLE DEPTH TESTING
      viewer.scene.globe.depthTestAgainstTerrain = true;

      // 4. DATA LOGIC
      const FEET_TO_METERS = 0.3048;
      let waterHeightFeet = 0; // Starting at Sea Level (in feet)

      // 5. CUSTOM SHADER FOR TERRAIN-BASED FLOODING
      // This shader colors terrain below the water level blue
      const fragmentShaderSource = `
        uniform float u_waterLevel;

        czm_material czm_getMaterial(czm_materialInput materialInput) {
          czm_material material = czm_getDefaultMaterial(materialInput);

          // Get the world position height (elevation above ellipsoid)
          float height = materialInput.height;

          // If below water level, color it blue
          if (height < u_waterLevel) {
            // Water color - semi-transparent blue
            material.diffuse = vec3(0.0, 0.4, 0.8);
            material.alpha = 0.75;
          }

          return material;
        }
      `;

      // Create the material
      const floodMaterial = new Cesium.Material({
        fabric: {
          type: 'FloodMaterial',
          uniforms: {
            u_waterLevel: 0.0,
          },
          source: fragmentShaderSource,
        },
      });

      // Apply material to globe
      viewer.scene.globe.material = floodMaterial;

      // 6. UI INTERACTION
      const slider = document.getElementById('heightSlider');
      const label = document.getElementById('currentHeight');

      function formatNumber(num) {
        return num.toLocaleString('en-US');
      }

      function updateWaterLevel(feet) {
        waterHeightFeet = feet;
        // Convert feet to meters and update the shader uniform
        const waterHeightMeters = waterHeightFeet * FEET_TO_METERS;
        floodMaterial.uniforms.u_waterLevel = waterHeightMeters;
        // Update the text label
        label.innerText = formatNumber(waterHeightFeet) + ' ft';
      }

      slider.addEventListener('input', function () {
        updateWaterLevel(parseFloat(this.value));
      });

      // 7. LOCAL STORAGE FOR CAMERA POSITION & WATER LEVEL
      const STORAGE_KEY = 'floodingViewerState';

      function saveState() {
        const camera = viewer.camera;
        const state = {
          position: {
            x: camera.position.x,
            y: camera.position.y,
            z: camera.position.z,
          },
          heading: camera.heading,
          pitch: camera.pitch,
          roll: camera.roll,
          waterHeightFeet: waterHeightFeet,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function loadState() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const state = JSON.parse(saved);
            viewer.camera.setView({
              destination: new Cesium.Cartesian3(
                state.position.x,
                state.position.y,
                state.position.z,
              ),
              orientation: {
                heading: state.heading,
                pitch: state.pitch,
                roll: state.roll,
              },
            });
            // Restore water level
            if (state.waterHeightFeet !== undefined) {
              slider.value = state.waterHeightFeet;
              updateWaterLevel(state.waterHeightFeet);
            }
            return true;
          } catch (e) {
            console.warn('Failed to load saved state:', e);
          }
        }
        return false;
      }

      // Try to load saved state, otherwise default to Utah
      if (!loadState()) {
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(-111.5, 39.5, 500000), // Utah
          orientation: {
            heading: 0.0,
            pitch: -0.7, // Looking down at an angle
            roll: 0.0,
          },
        });
      }

      // Save state when camera moves or water level changes
      viewer.camera.moveEnd.addEventListener(saveState);
      slider.addEventListener('change', saveState);

      // Change token button
      document
        .getElementById('changeTokenBtn')
        .addEventListener('click', clearCesiumToken);
    </script>
  </body>
</html>
